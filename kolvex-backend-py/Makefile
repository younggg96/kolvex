# Kolvex Backend Makefile

.PHONY: help install dev build up down logs clean test

# é»˜è®¤ç›®æ ‡
.DEFAULT_GOAL := help

help: ## æ˜¾ç¤ºå¸®åŠ©ä¿¡æ¯
	@echo "Kolvex Backend - å¯ç”¨å‘½ä»¤ï¼š"
	@echo ""
	@grep -E '^[a-zA-Z_-]+:.*?## .*$$' $(MAKEFILE_LIST) | awk 'BEGIN {FS = ":.*?## "}; {printf "  \033[36m%-15s\033[0m %s\n", $$1, $$2}'

install: ## å®‰è£…ä¾èµ–ï¼ˆè™šæ‹Ÿç¯å¢ƒï¼‰
	python3 -m venv venv
	. venv/bin/activate && pip install --upgrade pip
	. venv/bin/activate && pip install -r requirements.txt

dev: ## å¯åŠ¨å¼€å‘æœåŠ¡å™¨ï¼ˆæœ¬åœ°ï¼‰
	. venv/bin/activate && python3 main.py

docker-dev: ## ä½¿ç”¨ Docker å¯åŠ¨å¼€å‘ç¯å¢ƒ
	docker-compose up -d
	@echo "âœ… å¼€å‘ç¯å¢ƒå·²å¯åŠ¨"
	@echo "ğŸ“ API: http://localhost:8000"
	@echo "ğŸ“ æ–‡æ¡£: http://localhost:8000/docs"

docker-prod: ## ä½¿ç”¨ Docker å¯åŠ¨ç”Ÿäº§ç¯å¢ƒ
	docker-compose -f docker-compose.prod.yml up -d

build: ## æ„å»º Docker é•œåƒ
	docker-compose build

up: ## å¯åŠ¨æ‰€æœ‰æœåŠ¡
	docker-compose up -d

down: ## åœæ­¢æ‰€æœ‰æœåŠ¡
	docker-compose down

logs: ## æŸ¥çœ‹æ—¥å¿—
	docker-compose logs -f backend

logs-db: ## æŸ¥çœ‹æ•°æ®åº“æ—¥å¿—
	docker-compose logs -f db

ps: ## æŸ¥çœ‹è¿è¡ŒçŠ¶æ€
	docker-compose ps

shell: ## è¿›å…¥åç«¯å®¹å™¨
	docker-compose exec backend bash

db-shell: ## è¿›å…¥æ•°æ®åº“å®¹å™¨
	docker-compose exec db psql -U kolvex -d kolvex

clean: ## æ¸…ç†å®¹å™¨å’Œæ•°æ®å·
	docker-compose down -v
	rm -rf __pycache__
	find . -type d -name "__pycache__" -exec rm -rf {} +
	find . -type f -name "*.pyc" -delete

test: ## è¿è¡Œæµ‹è¯•
	. venv/bin/activate && pytest

migrate: ## è¿è¡Œæ•°æ®åº“è¿ç§»
	docker-compose exec backend alembic upgrade head

migrate-create: ## åˆ›å»ºæ–°çš„è¿ç§»
	@read -p "è¿ç§»æè¿°: " desc; \
	docker-compose exec backend alembic revision --autogenerate -m "$$desc"

env: ## åˆ›å»º .env æ–‡ä»¶
	cp .env.example .env
	@echo "âœ… å·²åˆ›å»º .env æ–‡ä»¶ï¼Œè¯·æ ¹æ®éœ€è¦ä¿®æ”¹é…ç½®"

health: ## å¥åº·æ£€æŸ¥
	@curl -s http://localhost:8000/health | python3 -m json.tool 2>/dev/null || curl -s http://localhost:8000/health

setup: env docker-dev ## åˆå§‹åŒ–é¡¹ç›®ï¼ˆåˆ›å»º .env + å¯åŠ¨æœåŠ¡ï¼‰
	@echo ""
	@echo "âœ… é¡¹ç›®è®¾ç½®å®Œæˆï¼"
	@echo "ğŸ“ API: http://localhost:8000"
	@echo "ğŸ“ æ–‡æ¡£: http://localhost:8000/docs"
